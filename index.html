<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Centro Ancianos Hatillo San Sebastián</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Aplicar tema oscuro si está guardado o es preferencia del sistema
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
          document.documentElement.classList.add('dark');
        } else {
          document.documentElement.classList.remove('dark');
        }
    </script>
    <style>
      @font-face {
        font-family: 'LucideIcons';
        src: url(https://cdn.jsdelivr.net/npm/lucide-static@latest/font/Lucide.ttf) format('truetype');
      }
      .lucide {
        font-family: 'LucideIcons'; font-size: 1.1rem; line-height: 1; display: inline-block;
        vertical-align: middle; font-style: normal; font-weight: normal; font-variant: normal;
        text-rendering: auto; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale;
      }
      /* Estilos Mensaje Flotante */
      #message-box {
          position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
          padding: 12px 24px; border-radius: 8px; color: white; z-index: 1050;
          opacity: 0; transition: opacity 0.5s ease-in-out, bottom 0.5s ease-in-out;
          font-family: 'Inter', sans-serif; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
          max-width: 90%; text-align: center;
      }
      #message-box.show { opacity: 1; bottom: 30px; }
      #message-box.success { background-color: #28a745; } #message-box.error { background-color: #dc3545; } #message-box.info { background-color: #17a2b8; }

      /* Estilos Modales */
      .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
      .modal.show { display: flex; }
      .modal-content { background-color: #fefefe; margin: auto; padding: 25px; border: 1px solid #888; width: 90%; max-width: 500px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); position: relative; }
      .dark .modal-content { background-color: #1f2937; border-color: #4b5563; } /* Gris oscuro 800, borde gris 600 */
      .modal-close-btn { position: absolute; top: 10px; right: 15px; color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; line-height: 1; }
      .modal-close-btn:hover, .modal-close-btn:focus { color: black; text-decoration: none; }
      .dark .modal-close-btn { color: #9ca3af; } /* Gris 400 */
      .dark .modal-close-btn:hover, .dark .modal-close-btn:focus { color: #e5e7eb; } /* Gris 200 */


      /* Estilos Filas Inventario (Pantalla) */
      .inventory-item.low-stock { background-color: #fff3cd; border-left: 4px solid #ffc107; }
      .dark .inventory-item.low-stock { background-color: rgba(250, 197, 24, 0.2); border-left-color: #facc15; } /* Amarillo oscuro transp */
      .inventory-item.expired { background-color: #f8d7da; border-left: 4px solid #dc3545; opacity: 0.8; }
      .dark .inventory-item.expired { background-color: rgba(220, 53, 69, 0.2); border-left-color: #f87171; opacity: 0.8; } /* Rojo oscuro transp */
      .inventory-item.needed { border-right: 4px solid #17a2b8; }
      .dark .inventory-item.needed { border-right-color: #22d3ee; } /* Cyan 400 */

      /* --- Estilos para Impresión Optimizada (Sin cambios) --- */
      @media print {
        /* Ocultar elementos específicos no deseados */
        #add-product-form-container,
        #controls-section, /* Contenedor de filtros y botones globales */
        .modal,
        #message-box,
        body > .container > h1, /* Título principal H1 */
        #inventory-list-container > h2, /* Título H2 "Inventario Actual" */
        #theme-toggle-container /* Contenedor del botón de tema */ {
          display: none !important;
        }

        /* Ocultar botones dentro de los items de la lista */
         .inventory-item > div:nth-child(3) { /* Contenedor de botones */
            display: none !important;
         }

        /* Estilos base para el cuerpo en impresión */
        body {
          font-size: 9pt !important;
          margin: 1cm !important; /* Margen de impresión */
          padding: 0 !important;
          background-color: white !important;
          color: black !important;
        }

        /* Asegurar que el contenedor principal y el de la lista sean visibles */
         .container {
             max-width: 100% !important; /* Ocupar ancho completo */
             padding: 0 !important;
             margin: 0 !important;
             box-shadow: none !important;
             border: none !important;
             background-color: white !important; /* Asegurar fondo blanco */
         }
        #inventory-list-container {
          position: static !important;
          width: 100% !important;
          margin: 0 !important;
          padding: 0 !important;
          border: none !important;
          box-shadow: none !important;
          background-color: white !important; /* Asegurar fondo blanco */
        }

        /* Convertir la lista en una tabla */
        #inventory-list {
          display: table !important;
          width: 100% !important;
          border-collapse: collapse !important;
          border: 1px solid #ccc !important; /* Borde exterior tabla */
          box-shadow: none !important;
          divide-y: initial !important;
        }

        /* Convertir cada item en una fila de tabla */
        .inventory-item {
          display: table-row !important;
          page-break-inside: avoid !important;
          border: none !important;
          background-color: white !important; /* Fondo blanco por defecto */
          opacity: 1 !important;
        }
        .inventory-item:nth-child(even) {
            background-color: #f8f8f8 !important; /* Gris muy claro alternado */
        }

        /* Convertir las divs internas (que NO son la de botones) en celdas de tabla */
        .inventory-item > div:nth-child(1), /* Celda Nombre/Categoría */
        .inventory-item > div:nth-child(2)  /* Celda Cantidad/Caducidad */
        {
            display: table-cell !important;
            border: 1px solid #ddd !important;
            padding: 4px 6px !important;
            vertical-align: top !important;
            font-size: 8pt !important;
            width: auto !important; /* Ajuste automático de ancho */
            color: black !important;
            background-color: transparent !important; /* Asegurar fondo transparente */
        }

         /* Ajustar contenido dentro de las celdas para compacidad */
         .inventory-item h3 {
             font-size: 9pt !important; font-weight: bold; margin: 0 0 2px 0; padding: 0; line-height: 1.1; color: black !important;
         }
         .inventory-item p {
             font-size: 8pt !important; margin: 0 0 1px 0; padding: 0; line-height: 1.1; color: black !important;
         }
         /* Usar selector más genérico para categoría por si cambia clase */
         .inventory-item div:nth-child(1) p:nth-of-type(1) { /* Asumiendo que es el primer <p> después del <h3> */
             display: inline; margin-left: 5px; font-size: 7pt !important; font-style: normal !important; color: #333 !important;
         }
          .inventory-item .text-xs { /* Indicadores Stock Bajo/Caducado */
              display: block; font-size: 7pt !important; font-weight: bold; margin-top: 2px; color: black !important;
          }
          .inventory-item span.font-medium {
              font-weight: normal !important;
          }
          /* Ocultar clases de color específicas de Tailwind en impresión */
          .inventory-item [class*="text-red-"],
          .inventory-item [class*="text-yellow-"],
          .inventory-item [class*="text-gray-"] {
              color: black !important;
          }
          /* Ocultar bordes específicos de estado */
          .inventory-item.low-stock, .inventory-item.expired, .inventory-item.needed {
              border: none !important;
          }
          /* Ocultar íconos Lucide */
          .lucide {
              display: none !important;
          }

      } /* Fin de @media print */
    </style>
    <script>
      // Configuración Tailwind con modo oscuro habilitado por clase
      tailwind.config = {
        darkMode: 'class', // Habilitar estrategia de clase para dark mode
        theme: {
          extend: {
            fontFamily: {
              sans: ['Inter', 'sans-serif'],
            },
          }
        }
      }
    </script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 font-sans transition-colors duration-300">

    <div class="container mx-auto p-4 md:p-6 lg:p-8 max-w-6xl">
        <h1 class="text-3xl font-bold text-center text-gray-800 dark:text-gray-100 mb-4">Centro Ancianos Hatillo San Sebastián</h1>

        <div id="theme-toggle-container" class="flex justify-center mb-6">
             <button id="theme-toggle-btn" title="Cambiar Tema" class="p-2 rounded-full bg-gray-200 hover:bg-gray-300 text-gray-700 dark:bg-gray-700 dark:text-gray-300 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:focus:ring-offset-gray-900">
                 <span id="theme-icon-placeholder" class="lucide w-5 h-5">
                     </span>
             </button>
         </div>


        <div id="message-box"></div>

        <div id="add-product-form-container" class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-md mb-8">
             <h2 class="text-xl font-semibold mb-4 text-gray-800 dark:text-gray-100">Agregar Nuevo Producto al Inventario</h2>
             <form id="add-product-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                 <div><label for="product-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Nombre:</label><input type="text" id="product-name" required class="w-full p-2 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white"></div>
                 <div><label for="category" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Categoría:</label><input type="text" id="category" placeholder="Ej: Verduras, Lácteos" class="w-full p-2 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white"></div>
                 <div><label for="quantity" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Cantidad Total:</label><input type="number" id="quantity" min="0" step="any" required class="w-full p-2 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white"></div>
                 <div><label for="quantity-unit" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Unidad (ej: kg, bolsas):</label><input type="text" id="quantity-unit" required class="w-full p-2 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white"></div>
                 <div><label for="items-per-unit" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Artículos/Unidad:</label><input type="number" id="items-per-unit" min="1" required value="1" class="w-full p-2 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white"></div>
                 <div><label for="expiry-date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Fecha Caducidad (Opc):</label><input type="date" id="expiry-date" class="w-full p-2 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:[color-scheme:dark]"></div>
                 <div><label for="low-stock-threshold" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Aviso Stock Bajo (Opc):</label><input type="number" id="low-stock-threshold" min="0" placeholder="Umbral cantidad total" class="w-full p-2 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white"></div>
                 <div class="md:col-span-2 lg:col-span-3"><button type="submit" class="w-full bg-green-600 hover:bg-green-700 dark:bg-green-700 dark:hover:bg-green-800 text-white font-bold py-2 px-4 rounded-md transition duration-150 ease-in-out flex items-center justify-center gap-2"><span class="lucide">&#xea11;</span> Agregar Producto</button></div>
             </form>
        </div>

        <div id="controls-section" class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md mb-8">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end mb-4">
                <div><label for="search-input" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Buscar por Nombre:</label><input type="text" id="search-input" placeholder="Escribe para filtrar..." class="w-full p-2 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white"></div>
                <div><label for="filter-category" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Filtrar por Categoría:</label><select id="filter-category" class="w-full p-2 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500 bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-white"><option value="">Todas</option></select></div>
                <div><label for="sort-by" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Ordenar por:</label><select id="sort-by" class="w-full p-2 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500 bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-white"><option value="name-asc">Nombre (A-Z)</option><option value="name-desc">Nombre (Z-A)</option><option value="quantity-asc">Cantidad (Menor a Mayor)</option><option value="quantity-desc">Cantidad (Mayor a Menor)</option><option value="expiry-asc">Caducidad (Más próxima)</option><option value="expiry-desc">Caducidad (Más lejana)</option><option value="category-asc">Categoría (A-Z)</option></select></div>
                <div><label for="filter-status" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Filtrar por Estado:</label><select id="filter-status" class="w-full p-2 border border-gray-300 rounded-md focus:ring-green-500 focus:border-green-500 bg-white dark:bg-gray-700 dark:border-gray-600 dark:text-white"><option value="">Todos</option><option value="needed">Necesarios (Lista Compra)</option><option value="low-stock">Stock Bajo</option><option value="expired">Caducados</option></select></div>
            </div>
             <div class="flex flex-col md:flex-row gap-3 justify-center mt-4">
                 <button id="export-btn" class="bg-blue-600 hover:bg-blue-700 dark:bg-blue-700 dark:hover:bg-blue-800 text-white font-bold py-2 px-4 rounded-md transition duration-150 ease-in-out flex items-center justify-center gap-2">
                    <span class="lucide">&#xe944;</span> Exportar (JSON)
                </button>
                <div class="relative">
                     <button id="import-btn-display" class="bg-purple-600 hover:bg-purple-700 dark:bg-purple-700 dark:hover:bg-purple-800 text-white font-bold py-2 px-4 rounded-md transition duration-150 ease-in-out flex items-center justify-center gap-2 w-full">
                        <span class="lucide">&#xe9ac;</span> Importar (JSON)
                    </button>
                    <input type="file" id="import-file" accept=".json" class="absolute top-0 left-0 w-full h-full opacity-0 cursor-pointer" title="Seleccionar archivo JSON para importar">
                </div>
                 <button id="print-btn" class="bg-teal-600 hover:bg-teal-700 dark:bg-teal-700 dark:hover:bg-teal-800 text-white font-bold py-2 px-4 rounded-md transition duration-150 ease-in-out flex items-center justify-center gap-2">
                    <span class="lucide">&#xe9fe;</span> Imprimir Lista
                </button>
            </div>
        </div>

         <div id="inventory-list-container" class="bg-white dark:bg-gray-800 rounded-lg shadow-md overflow-hidden">
             <h2 class="text-xl font-semibold p-4 bg-gray-50 dark:bg-gray-700 border-b dark:border-gray-600 text-gray-800 dark:text-gray-100">Inventario Actual</h2>
             <div id="inventory-list" class="divide-y divide-gray-200 dark:divide-gray-700">
                <p id="empty-message" class="p-6 text-gray-500 dark:text-gray-400 text-center hidden">El inventario está vacío o no hay coincidencias.</p>
                </div>
        </div>
    </div>

    <div id="edit-modal" class="modal"> <div class="modal-content"><span class="modal-close-btn" onclick="closeModal('edit-modal')">&times;</span><h3 class="text-lg font-semibold mb-4 text-gray-900 dark:text-gray-100">Editar Producto</h3><form id="edit-product-form">...</form></div></div>
    <div id="confirm-delete-modal" class="modal"> <div class="modal-content"><span class="modal-close-btn" onclick="closeModal('confirm-delete-modal')">&times;</span><h3 class="text-lg font-semibold mb-4 text-red-600 dark:text-red-500">Confirmar Eliminación</h3><p id="confirm-delete-message" class="mb-6 text-gray-700 dark:text-gray-300">¿Estás seguro?</p><div class="flex justify-end gap-3"><button type="button" onclick="closeModal('confirm-delete-modal')" class="bg-gray-300 hover:bg-gray-400 text-gray-800 dark:bg-gray-600 dark:hover:bg-gray-500 dark:text-gray-200 font-bold py-2 px-4 rounded-md transition duration-150 ease-in-out">Cancelar</button><button id="confirm-delete-btn" type="button" class="bg-red-600 hover:bg-red-700 dark:bg-red-700 dark:hover:bg-red-800 text-white font-bold py-2 px-4 rounded-md transition duration-150 ease-in-out">Eliminar</button></div></div></div>
    <div id="adjust-modal" class="modal"> <div class="modal-content"><span class="modal-close-btn" onclick="closeModal('adjust-modal')">&times;</span><h3 class="text-lg font-semibold mb-4 text-gray-900 dark:text-gray-100">Ajustar Cantidad</h3><form id="adjust-quantity-form">...</form></div></div>
     <div id="edit-modal" class="modal"> <div class="modal-content"><span class="modal-close-btn" onclick="closeModal('edit-modal')">&times;</span><h3 class="text-lg font-semibold mb-4 text-gray-900 dark:text-gray-100">Editar Producto</h3><form id="edit-product-form"><input type="hidden" id="edit-product-id"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label for="edit-product-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Nombre:</label><input type="text" id="edit-product-name" required class="w-full p-2 border border-gray-300 rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white"></div><div><label for="edit-category" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Categoría:</label><input type="text" id="edit-category" class="w-full p-2 border border-gray-300 rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white"></div><div><label for="edit-quantity" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Cantidad Total:</label><input type="number" id="edit-quantity" min="0" step="any" required class="w-full p-2 border border-gray-300 rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white"></div><div><label for="edit-quantity-unit" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Unidad:</label><input type="text" id="edit-quantity-unit" required class="w-full p-2 border border-gray-300 rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white"></div><div><label for="edit-items-per-unit" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Artículos/Unidad:</label><input type="number" id="edit-items-per-unit" min="1" required class="w-full p-2 border border-gray-300 rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white"></div><div><label for="edit-current-items" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Artículos Actuales:</label><input type="number" id="edit-current-items" min="0" required class="w-full p-2 border border-gray-300 rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white"></div><div><label for="edit-expiry-date" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Fecha Caducidad:</label><input type="date" id="edit-expiry-date" class="w-full p-2 border border-gray-300 rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white dark:[color-scheme:dark]"></div><div><label for="edit-low-stock-threshold" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Aviso Stock Bajo:</label><input type="number" id="edit-low-stock-threshold" min="0" class="w-full p-2 border border-gray-300 rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white"></div></div><div class="mt-6 flex justify-end gap-3"><button type="button" onclick="closeModal('edit-modal')" class="bg-gray-300 hover:bg-gray-400 text-gray-800 dark:bg-gray-600 dark:hover:bg-gray-500 dark:text-gray-200 font-bold py-2 px-4 rounded-md transition duration-150 ease-in-out">Cancelar</button><button type="submit" class="bg-green-600 hover:bg-green-700 dark:bg-green-700 dark:hover:bg-green-800 text-white font-bold py-2 px-4 rounded-md transition duration-150 ease-in-out">Guardar Cambios</button></div></form></div></div>
    <div id="adjust-modal" class="modal"> <div class="modal-content"><span class="modal-close-btn" onclick="closeModal('adjust-modal')">&times;</span><h3 class="text-lg font-semibold mb-4 text-gray-900 dark:text-gray-100">Ajustar Cantidad</h3><form id="adjust-quantity-form"><input type="hidden" id="adjust-product-id"><p class="mb-4 text-gray-700 dark:text-gray-300">Ajustar para: <strong id="adjust-product-name" class="text-gray-900 dark:text-gray-100"></strong></p><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4"><div><label for="adjust-quantity-change" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Cambio Cantidad Total:</label><input type="number" id="adjust-quantity-change" step="any" placeholder="Ej: 1, -0.5" class="w-full p-2 border border-gray-300 rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white"><p class="text-xs text-gray-500 dark:text-gray-400">Positivo añade, negativo quita.</p></div><div><label for="adjust-items-change" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Cambio Artículos Actuales:</label><input type="number" id="adjust-items-change" step="1" placeholder="Ej: 5, -2" class="w-full p-2 border border-gray-300 rounded-md dark:bg-gray-700 dark:border-gray-600 dark:text-white"><p class="text-xs text-gray-500 dark:text-gray-400">Positivo añade, negativo quita.</p></div></div><div class="mt-6 flex justify-end gap-3"><button type="button" onclick="closeModal('adjust-modal')" class="bg-gray-300 hover:bg-gray-400 text-gray-800 dark:bg-gray-600 dark:hover:bg-gray-500 dark:text-gray-200 font-bold py-2 px-4 rounded-md transition duration-150 ease-in-out">Cancelar</button><button type="submit" class="bg-blue-600 hover:bg-blue-700 dark:bg-blue-700 dark:hover:bg-blue-800 text-white font-bold py-2 px-4 rounded-md transition duration-150 ease-in-out">Aplicar Ajuste</button></div></form></div></div>


    <script>
        // --- Selectores de Elementos ---
        const addProductForm = document.getElementById('add-product-form');
        const inventoryList = document.getElementById('inventory-list');
        const searchInput = document.getElementById('search-input');
        const filterCategorySelect = document.getElementById('filter-category');
        const sortBySelect = document.getElementById('sort-by');
        const filterStatusSelect = document.getElementById('filter-status');
        const emptyMessage = document.getElementById('empty-message');
        const messageBox = document.getElementById('message-box');
        const printBtn = document.getElementById('print-btn');
        const themeToggleBtn = document.getElementById('theme-toggle-btn'); // Botón único de tema
        const themeIconPlaceholder = document.getElementById('theme-icon-placeholder'); // Span para el icono
        const exportBtn = document.getElementById('export-btn'); // Botón Exportar
        const importFileInput = document.getElementById('import-file'); // Input de archivo oculto
        const importBtnDisplay = document.getElementById('import-btn-display'); // Botón visible para importar

        // Modales (Selectores sin cambios)
        const editModal = document.getElementById('edit-modal');
        const confirmDeleteModal = document.getElementById('confirm-delete-modal');
        const adjustModal = document.getElementById('adjust-modal');
        const editProductForm = document.getElementById('edit-product-form');
        const adjustQuantityForm = document.getElementById('adjust-quantity-form');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');

        // --- Estado Global ---
        let messageTimeout;
        let itemToDeleteId = null;
        const today = new Date().toISOString().split('T')[0];

        // --- Funciones de Utilidad (sin cambios) ---
        showMessage = (text, type = 'success', duration = 3500) => { messageBox.textContent = text; messageBox.className = `show ${type}`; if (messageTimeout) clearTimeout(messageTimeout); messageTimeout = setTimeout(() => { messageBox.className = messageBox.className.replace('show', ''); }, duration); };
        getInventory = () => { const inventory = localStorage.getItem('groceryInventoryAdv'); return inventory ? JSON.parse(inventory) : []; };
        saveInventory = (inventory) => { localStorage.setItem('groceryInventoryAdv', JSON.stringify(inventory)); populateCategoryFilter(); renderInventory(); };
        openModal = (modalId) => { document.getElementById(modalId)?.classList.add('show'); };
        closeModal = (modalId) => { document.getElementById(modalId)?.classList.remove('show'); };
        window.onclick = (event) => { if (event.target.classList.contains('modal')) { event.target.classList.remove('show'); } };
        populateCategoryFilter = () => { const inventory = getInventory(); const categories = [...new Set(inventory.map(item => item.category).filter(Boolean))].sort(); const currentFilterValue = filterCategorySelect.value; filterCategorySelect.innerHTML = '<option value="">Todas</option>'; categories.forEach(cat => { const option = document.createElement('option'); option.value = cat; option.textContent = cat; filterCategorySelect.appendChild(option); }); if (categories.includes(currentFilterValue)) { filterCategorySelect.value = currentFilterValue; } };


        // --- Lógica Principal del Inventario ---

        function renderInventory() {
            let inventory = getInventory();
            inventoryList.innerHTML = '';

            // 1. Filtrar (sin cambios)
            const searchTerm = searchInput.value.toLowerCase();
            const selectedCategory = filterCategorySelect.value;
            const selectedStatus = filterStatusSelect.value;
            inventory = inventory.filter(item => { /* ... lógica filtro sin cambios ... */
                const nameMatch = item.name.toLowerCase().includes(searchTerm);
                const categoryMatch = !selectedCategory || item.category === selectedCategory;
                let statusMatch = true;
                if (selectedStatus) {
                    switch (selectedStatus) {
                        case 'needed': statusMatch = item.isNeeded === true; break;
                        case 'low-stock': const threshold = item.lowStockThreshold !== null && !isNaN(parseFloat(item.lowStockThreshold)) ? parseFloat(item.lowStockThreshold) : null; statusMatch = threshold !== null && item.quantity <= threshold; break;
                        case 'expired': statusMatch = item.expiryDate && item.expiryDate < today; break;
                    }
                }
                return nameMatch && categoryMatch && statusMatch;
             });

            // 2. Ordenar (sin cambios)
            const sortBy = sortBySelect.value;
            inventory.sort((a, b) => { /* ... lógica ordenación sin cambios ... */
                 switch (sortBy) {
                    case 'name-asc': return a.name.localeCompare(b.name);
                    case 'name-desc': return b.name.localeCompare(a.name);
                    case 'quantity-asc': return a.quantity - b.quantity;
                    case 'quantity-desc': return b.quantity - a.quantity;
                    case 'expiry-asc': if (!a.expiryDate && !b.expiryDate) return 0; if (!a.expiryDate) return 1; if (!b.expiryDate) return -1; return new Date(a.expiryDate) - new Date(b.expiryDate);
                    case 'expiry-desc': if (!a.expiryDate && !b.expiryDate) return 0; if (!a.expiryDate) return 1; if (!b.expiryDate) return -1; return new Date(b.expiryDate) - new Date(a.expiryDate);
                    case 'category-asc': return (a.category || '').localeCompare(b.category || '');
                    default: return 0;
                }
            });

            // 3. Mostrar
            if (inventory.length === 0) {
                emptyMessage.classList.remove('hidden');
                emptyMessage.textContent = "El inventario está vacío o no hay coincidencias con los filtros aplicados.";
            } else {
                emptyMessage.classList.add('hidden');
                inventory.forEach(item => {
                    const itemElement = document.createElement('div');
                    // Clases base + clases dark:
                    itemElement.className = 'inventory-item p-4 grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4 items-start relative dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700'; // Añadido borde explícito
                    itemElement.dataset.id = item.id;

                    // Aplicar clases de estado (para pantalla)
                    const isExpired = item.expiryDate && item.expiryDate < today;
                    const threshold = item.lowStockThreshold !== null && !isNaN(parseFloat(item.lowStockThreshold)) ? parseFloat(item.lowStockThreshold) : null;
                    const isLowStock = threshold !== null && item.quantity <= threshold;
                    if (isExpired) itemElement.classList.add('expired'); else if (isLowStock) itemElement.classList.add('low-stock');
                    if (item.isNeeded) itemElement.classList.add('needed');

                    // --- HTML Interno con Botones en Cuadrícula (Usando Grid) ---
                    // Añadir clases dark: a los textos
                    let nameHtml = `<h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">${item.name}</h3>`;
                    if (item.category) nameHtml += `<p class="text-sm text-gray-500 dark:text-gray-400 italic">${item.category}</p>`;
                    if (isExpired) nameHtml += `<span class="text-xs font-bold text-red-600 dark:text-red-400 block">CADUCADO</span>`; else if (isLowStock) nameHtml += `<span class="text-xs font-bold text-yellow-600 dark:text-yellow-400 block">STOCK BAJO</span>`;

                    let quantityHtml = `<p class="text-sm text-gray-700 dark:text-gray-300">Total: <span class="font-medium">${item.quantity}</span> ${item.quantityUnit}</p><p class="text-sm text-gray-700 dark:text-gray-300">Actual: <span class="font-medium">${item.currentItems}</span> / ${item.itemsPerUnit} por ${item.quantityUnit}</p>`;
                    if (item.expiryDate) { const expiryDateObj = new Date(item.expiryDate + 'T00:00:00'); const formattedDate = expiryDateObj.toLocaleDateString(undefined, { year: 'numeric', month: 'numeric', day: 'numeric' }); quantityHtml += `<p class="text-sm ${isExpired ? 'text-red-700 dark:text-red-400 font-semibold' : 'text-gray-600 dark:text-gray-400'}">Caduca: ${formattedDate}</p>`; }

                    // Botones organizados en cuadrícula de 3 columnas (con clases dark:)
                    const neededIcon = item.isNeeded ? '&#xea5b;' : '&#xea11;';
                    const neededText = item.isNeeded ? 'Necesario' : 'Marcar';
                    const neededTitle = item.isNeeded ? 'Quitar de Necesarios' : 'Marcar como Necesario';
                    // Ajustar clases de fondo para dark mode en botón 'needed'
                    const neededBgClass = item.isNeeded ? 'bg-indigo-600 hover:bg-indigo-700 dark:bg-indigo-500 dark:hover:bg-indigo-600' : 'bg-gray-400 hover:bg-gray-500 dark:bg-gray-600 dark:hover:bg-gray-500';

                    // Contenedor principal para los botones, usando grid
                    const actionsHtml = `
                        <div class="grid grid-cols-3 gap-1 mt-2 md:mt-0 col-span-1 md:col-span-1 lg:col-span-2 justify-items-end">
                            <button class="use-item-btn bg-blue-500 hover:bg-blue-600 dark:bg-blue-600 dark:hover:bg-blue-700 text-white p-1 px-2 rounded-md text-xs transition duration-150 ease-in-out flex items-center gap-1 justify-center w-full" title="Usar un artículo">
                                <span class="lucide">&#xe911;</span> Usar
                            </button>
                            <button class="adjust-item-btn bg-yellow-500 hover:bg-yellow-600 dark:bg-yellow-600 dark:hover:bg-yellow-700 text-white p-1 px-2 rounded-md text-xs transition duration-150 ease-in-out flex items-center gap-1 justify-center w-full" title="Ajustar cantidad">
                                <span class="lucide">&#xea73;</span> Ajustar
                            </button>
                            <button class="edit-item-btn bg-green-500 hover:bg-green-600 dark:bg-green-600 dark:hover:bg-green-700 text-white p-1 px-2 rounded-md text-xs transition duration-150 ease-in-out flex items-center gap-1 justify-center w-full" title="Editar producto">
                                <span class="lucide">&#xe9cb;</span> Editar
                            </button>
                             <button class="toggle-needed-btn ${neededBgClass} text-white p-1 px-2 rounded-md text-xs transition duration-150 ease-in-out flex items-center gap-1 justify-center w-full" title="${neededTitle}">
                                <span class="lucide">${neededIcon}</span> ${neededText}
                            </button>
                            <button class="delete-item-btn bg-red-500 hover:bg-red-600 dark:bg-red-600 dark:hover:bg-red-700 text-white p-1 px-2 rounded-md text-xs transition duration-150 ease-in-out flex items-center gap-1 justify-center w-full" title="Eliminar producto">
                                <span class="lucide">&#xea0f;</span> Eliminar
                            </button>
                            </div>`;

                    // Estructura de 3 divs para las celdas de impresión/columnas de pantalla
                    itemElement.innerHTML = `
                        <div>${nameHtml}</div>
                        <div>${quantityHtml}</div>
                        <div>${actionsHtml}</div>
                    `;
                    inventoryList.appendChild(itemElement);
                });
            }
            addEventListenersToButtons(); // Re-asignar listeners
        }

        function addEventListenersToButtons() {
             // Asignar listeners a TODOS los botones directamente
             document.querySelectorAll('.inventory-item').forEach(itemRow => {
                const id = itemRow.dataset.id;
                const cleanAndAddListener = (selector, handler, parent = itemRow) => {
                    const button = parent.querySelector(selector);
                    if (!button) return;
                    const cleanBtn = button.cloneNode(true);
                    button.replaceWith(cleanBtn);
                    cleanBtn.addEventListener('click', (e) => {
                        handler(id);
                    });
                };

                cleanAndAddListener('.use-item-btn', handleUseItem);
                cleanAndAddListener('.adjust-item-btn', openAdjustModal);
                cleanAndAddListener('.edit-item-btn', openEditModal);
                cleanAndAddListener('.toggle-needed-btn', handleToggleNeeded);
                cleanAndAddListener('.delete-item-btn', openDeleteConfirmation);
            });
        }

        // --- Manejadores de Eventos (CRUD y Modales sin cambios) ---
        addProductForm.addEventListener('submit', (event) => { /* ... */ });
        function handleUseItem(id) { /* ... */ }
        function handleToggleNeeded(id) { /* ... */ }
        function openEditModal(id) { /* ... */ }
        editProductForm.addEventListener('submit', (event) => { /* ... */ });
        function openAdjustModal(id) { /* ... */ }
        adjustQuantityForm.addEventListener('submit', (event) => { /* ... */ });
        function openDeleteConfirmation(id) { /* ... */ }
        confirmDeleteBtn.addEventListener('click', () => { /* ... */ });
        // Implementaciones de manejadores (sin cambios respecto a la versión anterior)
        addProductForm.addEventListener('submit', (event) => { event.preventDefault(); const inventory = getInventory(); const name = document.getElementById('product-name').value.trim(); const quantity = parseFloat(document.getElementById('quantity').value); const quantityUnit = document.getElementById('quantity-unit').value.trim(); const itemsPerUnit = parseInt(document.getElementById('items-per-unit').value, 10); const category = document.getElementById('category').value.trim(); const expiryDate = document.getElementById('expiry-date').value || null; const lowStockThresholdInput = document.getElementById('low-stock-threshold').value; const lowStockThreshold = lowStockThresholdInput ? parseFloat(lowStockThresholdInput) : null; if (!name || !quantityUnit || isNaN(quantity) || quantity < 0 || isNaN(itemsPerUnit) || itemsPerUnit <= 0) { showMessage('Por favor, completa los campos obligatorios (Nombre, Cantidad, Unidad, Artículos/Unidad) con valores válidos.', 'error'); return; } if (lowStockThreshold !== null && isNaN(lowStockThreshold)) { showMessage('El umbral de stock bajo debe ser un número.', 'error'); return; } const newItem = { id: Date.now().toString(), name: name, category: category, quantity: quantity, quantityUnit: quantityUnit, itemsPerUnit: itemsPerUnit, currentItems: Math.max(0, quantity * itemsPerUnit), expiryDate: expiryDate, lowStockThreshold: lowStockThreshold, isNeeded: false }; inventory.push(newItem); saveInventory(inventory); showMessage(`'${name}' agregado al inventario.`, 'success'); addProductForm.reset(); });
        handleUseItem = (id) => { const inventory = getInventory(); const itemIndex = inventory.findIndex(item => item.id === id); if (itemIndex === -1) return; const item = inventory[itemIndex]; if (item.currentItems > 0) { item.currentItems -= 1; if (item.currentItems === 0 && item.quantity > 0) { item.quantity -= 1; if (item.quantity > 0) { item.currentItems = item.itemsPerUnit; showMessage(`Se usó un artículo de '${item.name}'. Se consumió una unidad completa. Quedan ${item.quantity} ${item.quantityUnit}.`, 'info'); } else { showMessage(`Se usó el último artículo de '${item.name}'. Cantidad total agotada.`, 'info'); } } else if (item.currentItems === 0 && item.quantity === 0) { showMessage(`No quedan más artículos ni cantidad de '${item.name}'.`, 'error'); return; } else { showMessage(`Se usó un artículo de '${item.name}'. Quedan ${item.currentItems}.`, 'info'); } saveInventory(inventory); } else { showMessage(`No quedan artículos individuales de '${item.name}' para usar. Considera ajustar la cantidad.`, 'error'); } };
        handleToggleNeeded = (id) => { const inventory = getInventory(); const itemIndex = inventory.findIndex(item => item.id === id); if (itemIndex === -1) return; inventory[itemIndex].isNeeded = !inventory[itemIndex].isNeeded; saveInventory(inventory); showMessage(inventory[itemIndex].isNeeded ? `'${inventory[itemIndex].name}' marcado como necesario.` : `'${inventory[itemIndex].name}' quitado de necesarios.`, 'info'); };
        openEditModal = (id) => { const inventory = getInventory(); const item = inventory.find(item => item.id === id); if (!item) return; document.getElementById('edit-product-id').value = item.id; document.getElementById('edit-product-name').value = item.name; document.getElementById('edit-category').value = item.category || ''; document.getElementById('edit-quantity').value = item.quantity; document.getElementById('edit-quantity-unit').value = item.quantityUnit; document.getElementById('edit-items-per-unit').value = item.itemsPerUnit; document.getElementById('edit-current-items').value = item.currentItems; document.getElementById('edit-expiry-date').value = item.expiryDate || ''; document.getElementById('edit-low-stock-threshold').value = item.lowStockThreshold !== null ? item.lowStockThreshold : ''; openModal('edit-modal'); };
        editProductForm.addEventListener('submit', (event) => { event.preventDefault(); const id = document.getElementById('edit-product-id').value; const inventory = getInventory(); const itemIndex = inventory.findIndex(item => item.id === id); if (itemIndex === -1) return; const name = document.getElementById('edit-product-name').value.trim(); const quantity = parseFloat(document.getElementById('edit-quantity').value); const quantityUnit = document.getElementById('edit-quantity-unit').value.trim(); const itemsPerUnit = parseInt(document.getElementById('edit-items-per-unit').value, 10); const currentItems = parseInt(document.getElementById('edit-current-items').value, 10); const category = document.getElementById('edit-category').value.trim(); const expiryDate = document.getElementById('edit-expiry-date').value || null; const lowStockThresholdInput = document.getElementById('edit-low-stock-threshold').value; const lowStockThreshold = lowStockThresholdInput ? parseFloat(lowStockThresholdInput) : null; if (!name || !quantityUnit || isNaN(quantity) || quantity < 0 || isNaN(itemsPerUnit) || itemsPerUnit <= 0 || isNaN(currentItems) || currentItems < 0) { showMessage('Error: Revisa los campos numéricos y obligatorios.', 'error'); return; } if (lowStockThreshold !== null && isNaN(lowStockThreshold)) { showMessage('El umbral de stock bajo debe ser un número.', 'error'); return; } const maxPossibleItems = quantity * itemsPerUnit; if (currentItems > maxPossibleItems) { showMessage(`Error: Los artículos actuales (${currentItems}) no pueden exceder el máximo posible (${maxPossibleItems}) para la cantidad total.`, 'error'); return; } inventory[itemIndex] = { ...inventory[itemIndex], name, category, quantity, quantityUnit, itemsPerUnit, currentItems, expiryDate, lowStockThreshold }; saveInventory(inventory); closeModal('edit-modal'); showMessage(`'${name}' actualizado correctamente.`, 'success'); });
        openAdjustModal = (id) => { const inventory = getInventory(); const item = inventory.find(item => item.id === id); if (!item) return; document.getElementById('adjust-product-id').value = item.id; document.getElementById('adjust-product-name').textContent = item.name; adjustQuantityForm.reset(); openModal('adjust-modal'); };
        adjustQuantityForm.addEventListener('submit', (event) => { event.preventDefault(); const id = document.getElementById('adjust-product-id').value; const inventory = getInventory(); const itemIndex = inventory.findIndex(item => item.id === id); if (itemIndex === -1) return; const item = inventory[itemIndex]; const quantityChange = parseFloat(document.getElementById('adjust-quantity-change').value || 0); const itemsChange = parseInt(document.getElementById('adjust-items-change').value || 0); if (isNaN(quantityChange) || isNaN(itemsChange)) { showMessage('Por favor, introduce valores numéricos para los ajustes.', 'error'); return; } const originalQuantity = item.quantity; const originalCurrentItems = item.currentItems; let newQuantity = Math.max(0, originalQuantity + quantityChange); let newCurrentItems = Math.max(0, originalCurrentItems + itemsChange); const maxPossibleItems = newQuantity * item.itemsPerUnit; if (newCurrentItems > maxPossibleItems) { showMessage(`Error: El ajuste resultaría en ${newCurrentItems} artículos actuales, pero el máximo para ${newQuantity} ${item.quantityUnit} es ${maxPossibleItems}. Ajuste cancelado.`, 'error', 5000); return; } if (newQuantity === 0) newCurrentItems = 0; item.quantity = newQuantity; item.currentItems = newCurrentItems; saveInventory(inventory); closeModal('adjust-modal'); showMessage(`Cantidad de '${item.name}' ajustada.`, 'success'); });
        openDeleteConfirmation = (id) => { const inventory = getInventory(); const item = inventory.find(item => item.id === id); if (!item) return; itemToDeleteId = id; document.getElementById('confirm-delete-message').textContent = `¿Estás seguro de que quieres eliminar '${item.name}' (${item.quantity} ${item.quantityUnit}) del inventario?`; openModal('confirm-delete-modal'); };
        confirmDeleteBtn.addEventListener('click', () => { if (itemToDeleteId) { let inventory = getInventory(); const itemIndex = inventory.findIndex(item => item.id === itemToDeleteId); const itemName = itemIndex !== -1 ? inventory[itemIndex].name : 'Producto desconocido'; inventory = inventory.filter(item => item.id !== itemToDeleteId); saveInventory(inventory); closeModal('confirm-delete-modal'); showMessage(`'${itemName}' eliminado del inventario.`, 'success'); itemToDeleteId = null; } });


        // --- Manejador para Imprimir ---
        printBtn.addEventListener('click', () => { showMessage('Preparando vista de impresión...', 'info', 1500); setTimeout(() => { window.print(); }, 200); });

        // --- Manejador para el botón ÚNICO de Tema ---
        themeToggleBtn.addEventListener('click', () => {
            const isDarkMode = document.documentElement.classList.contains('dark');
            if (isDarkMode) {
                document.documentElement.classList.remove('dark');
                localStorage.theme = 'light';
            } else {
                document.documentElement.classList.add('dark');
                localStorage.theme = 'dark';
            }
            updateThemeButtonIcon();
        });

        // Función para actualizar el icono del botón de tema
        function updateThemeButtonIcon() {
            if (document.documentElement.classList.contains('dark')) {
                themeIconPlaceholder.innerHTML = '&#xea80;'; // sun icon
                themeToggleBtn.title = "Cambiar a Modo Claro";
            } else {
                themeIconPlaceholder.innerHTML = '&#xe9c2;'; // moon icon
                themeToggleBtn.title = "Cambiar a Modo Oscuro";
            }
        }

        // --- Lógica Exportar / Importar (con FUSIÓN) ---
        exportBtn.addEventListener('click', () => {
            const inventory = getInventory();
            if (inventory.length === 0) {
                showMessage('El inventario está vacío, nada que exportar.', 'info');
                return;
            }
            const dataStr = JSON.stringify(inventory, null, 2); // Formato legible
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            const date = new Date().toISOString().slice(0, 10);
            link.download = `inventario_centro_ancianos_${date}.json`; // Nombre de archivo
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            showMessage('Inventario exportado como JSON.', 'success');
        });

        // Listener para el input de archivo oculto (Importar)
        importFileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) { return; }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);

                    // Validación básica de la estructura importada
                    if (!Array.isArray(importedData)) {
                         throw new Error('El archivo no contiene un array JSON.');
                    }
                    if (importedData.length > 0 && (typeof importedData[0].name === 'undefined' || typeof importedData[0].quantity === 'undefined')) {
                         throw new Error('El archivo JSON no parece tener la estructura de inventario esperada.');
                    }

                    // *** Lógica de Fusión ***
                    if (confirm(`Se fusionarán ${importedData.length} productos del archivo con tu inventario actual. Los productos existentes se actualizarán y los nuevos se añadirán. ¿Continuar?`)) {

                        let currentInventory = getInventory(); // Obtener inventario actual
                        let updatedCount = 0;
                        let addedCount = 0;

                        // Limpiar y procesar cada item importado
                        importedData.forEach(importedItem => {
                            // Limpieza básica del item importado
                            const name = typeof importedItem.name === 'string' ? importedItem.name.trim() : 'Sin nombre';
                            const category = typeof importedItem.category === 'string' ? importedItem.category.trim() : '';
                            const quantity = !isNaN(parseFloat(importedItem.quantity)) ? Math.max(0, parseFloat(importedItem.quantity)) : 0;
                            const quantityUnit = typeof importedItem.quantityUnit === 'string' ? importedItem.quantityUnit.trim() : 'unidad';
                            const itemsPerUnit = !isNaN(parseInt(importedItem.itemsPerUnit)) ? Math.max(1, parseInt(importedItem.itemsPerUnit)) : 1;
                            const currentItemsInput = !isNaN(parseInt(importedItem.currentItems)) ? parseInt(importedItem.currentItems) : 0;
                            const currentItems = Math.max(0, Math.min(currentItemsInput, quantity * itemsPerUnit));
                            const expiryDateRegex = /^\d{4}-\d{2}-\d{2}$/;
                            const expiryDate = typeof importedItem.expiryDate === 'string' && expiryDateRegex.test(importedItem.expiryDate) ? importedItem.expiryDate : null;
                            const lowStockThresholdInput = importedItem.lowStockThreshold;
                            const lowStockThreshold = lowStockThresholdInput !== null && !isNaN(parseFloat(lowStockThresholdInput)) ? Math.max(0, parseFloat(lowStockThresholdInput)) : null;
                            const isNeeded = importedItem.isNeeded === true;

                            // Buscar item existente por nombre y unidad (insensible a mayúsculas/minúsculas)
                            const existingItemIndex = currentInventory.findIndex(currentItem =>
                                currentItem.name.toLowerCase() === name.toLowerCase() &&
                                currentItem.quantityUnit.toLowerCase() === quantityUnit.toLowerCase()
                            );

                            if (existingItemIndex > -1) {
                                // --- Actualizar Item Existente ---
                                // Conservar el ID original del inventario actual
                                const existingId = currentInventory[existingItemIndex].id;
                                currentInventory[existingItemIndex] = {
                                    id: existingId, // Mantener ID existente
                                    name, category, quantity, quantityUnit, itemsPerUnit,
                                    currentItems, expiryDate, lowStockThreshold, isNeeded
                                };
                                updatedCount++;
                            } else {
                                // --- Añadir Item Nuevo ---
                                const newItem = {
                                    id: importedItem.id || Date.now().toString() + Math.random(), // Usar ID importado si existe, si no, generar uno nuevo
                                    name, category, quantity, quantityUnit, itemsPerUnit,
                                    currentItems, expiryDate, lowStockThreshold, isNeeded
                                };
                                currentInventory.push(newItem);
                                addedCount++;
                            }
                        }); // Fin del forEach

                        saveInventory(currentInventory); // Guardar el inventario fusionado
                        showMessage(`Importación completada: ${updatedCount} actualizados, ${addedCount} añadidos.`, 'success', 4000);
                    } else {
                         showMessage('Importación cancelada.', 'info');
                    }

                } catch (error) {
                    showMessage(`Error al importar el archivo: ${error.message}`, 'error', 5000);
                } finally {
                     importFileInput.value = ''; // Resetear input
                }
            };
            reader.onerror = () => {
                 showMessage('Error al leer el archivo.', 'error');
                 importFileInput.value = '';
            };
            reader.readAsText(file);
        });


        // --- Event Listeners para Filtros y Ordenación (sin cambios) ---
        searchInput.addEventListener('input', renderInventory);
        filterCategorySelect.addEventListener('change', renderInventory);
        sortBySelect.addEventListener('change', renderInventory);
        filterStatusSelect.addEventListener('change', renderInventory);

        // --- Inicialización ---
        document.addEventListener('DOMContentLoaded', () => {
             populateCategoryFilter();
             renderInventory();
             updateThemeButtonIcon(); // Establecer el icono correcto al cargar
        });

    </script>

</body>
</html>
